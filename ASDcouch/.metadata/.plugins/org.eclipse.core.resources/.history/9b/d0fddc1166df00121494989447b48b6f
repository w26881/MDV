/*Kevin Tresemer
	  ASD 1306*/
	  
$('#home').on('pageinit', function(){
	
});

$('#add').on('pageinit', function(){
	var myForm = $('#addRelationshipForm');
	myForm.validate({
		invalidHandler: function(form, validator) {
		},
		submitHandler: function() {
			var data = myForm.serializeArray();
			storeData(data);
		}
	});

});

$('#display').on('pageinit', function(){
	
});

var clearData = function(){
	if (localStorage.length === 0) {
			alert("There is no data.");
		} else {
			localStorage.clear();
			alert("Data cleared.");
			$("#items").empty();
			return false;
		}
};

$(document).on('pageinit', '#display', function () {
var labels = ["Status: ", "Name: ", "Tel: ", "Notes: "];
	    $.couch.db("asdproject").view("app/status", {
			"success":function(data) {
			console.log(data);
				$.each(data.rows, function(index, rel) {
				var makeSubList = $('<div>')
					.attr('data-role', 'collapsible')
					.attr('data-mini', 'true')
					.attr('id', rel.key)
					.appendTo('#items')
				;

				var makeH3 = $('<h3>')
					.html(rel.value.name + ' - ' + rel.value.status)
					.appendTo(makeSubList)
				;

				var makeDetailsList = $('<ul>').appendTo(makeSubList);
				var labelCounter = 0;
				for (var k in rel.value) {
					var makeLi = $('<li>')
						.html(labels[labelCounter] + rel.value[k])
						.appendTo(makeDetailsList)
					;
					labelCounter++;
				}
				
				
				/*	var id 	= rel.id;
            		var rev = rel.rev;
					var makeSubList = $('<div></div>')
					var parsed = $(
							'<p>' + "id:" + rel.id  + '</p>' + 
							'<p>' + "Status:" + rel.value.status  + '</p>' + 
							'<p>' + "Name:" + rel.value.name + '</p>' + 
							'<p>' + "Tel:" + rel.value.tel + '</p>' + 
							'<p>' + "Notes:" + rel.value.notes + '</p>' +
							'<br>'
					);*/
					var buttonHolder = $('<div>').attr('class', 'ui-grid-a').appendTo(makeSubList);
					var editButtonDiv = $('<div>').attr('class', 'ui-block-a').appendTo(buttonHolder);
					var removeButtonDiv = $('<div>').attr('class', 'ui-block-b').appendTo(buttonHolder);
					var editButton = $('<a>')
					.attr('data-role', 'button')
					.attr('href', '#add')
					.html('Edit')
					.data('key', rel.key)
					.data('rev', rel.rev)
					.appendTo(editButtonDiv)
					.on('click', editRel);
				var removeButton = $('<a>')
					.attr('data-role', 'button')
					.attr('href', '#')
					.html('Remove')
					.data('key', rel.key)
					.data('rev', rel.rev)
					.appendTo(removeButtonDiv)
					.on('click', deleteRel);
				console.log(rel.key);
				console.log(rel.rev);
				$(makeSubList).trigger('create');
			});
			$('#items').trigger('create');
		}
	});
});
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
/*					var editRel = $("<button><a href='#add' id='edit' + index + ''> Edit Relationship</a></button>");
                	editRel.on('click', function () {
                    $.couch.db("asdproject").openDoc(id, {
                        success: function (data) {
                        	keyVar = {
								_id: id,
							    _rev: rev
							};
                            console.log(keyVar);
                            $("#status").val(rel.value.status);
                            $("#name").val(rel.value.name);
                            $("#tel").val(rel.value.tel);
                            $("#notes").val(rel.value.notes);
                            $('#saveData').prev('.ui-btn-inner').children('.ui-btn-text').html('Update Relationship');
                            console.log(keyVar);
                        }
                    });
                });
                var deleteRel = $("<button><a href='#' id='delete' + index + ''>Delete Relationship</a></button>");
                deleteRel.on('click', function () {
                	keyVar = {
						_id: id,
					    _rev: rev
					};
                    var ask = confirm("Delete This Relationship?");
                    if (ask) {
                        $.couch.db("asdproject").removeDoc(keyVar, {
                            success: function (data) {
                            	keyVar = null
                            	window.location.reload("#");
                            }
                        });
                    }
                });	
					makeSubList.append(parsed).append(editRel).append("<br>").append(deleteRel).appendTo("#items");
				});
			},

		});

}); */

var storeData = function(data){
	var key = $('#addRel').data('key');
	var rev = $('#addRel').data('rev');
	console.log(key);
	console.log(rev);
	var rel = {};

	if (rev) {	
		rel._id = key;
		rel._rev = rev;
	}

	// add the rest of the data
	rel.status = $("#status").val();
	rel.name = $("#name").val();
	rel.tel = $("#tel").val();
	rel.notes = $("#notes").val();

	console.log(rel);

	$.couch.db('asdproject').saveDoc(rel, {
		success: function(rel){
			alert('Relationship Saved.');
			$('#addRel').attr('value', 'Add Relationship').removeData('key').removeData('rev');
			$.mobile.changePage('#home');
		}
	});
}; 

var editRel = function (){
	var key = $(this).data('key');
	var rev = $(this).data('rev');

	$.couch.db('asdproject').openDoc(key,{
		success: function(rel) {
			$('#status').val(rel.status);
			$('#name').val(rel.name);
			$('#tel').val(rel.tel);
			$('#notes').val(rel.notes);
			$('#addRel').attr('value', 'Update Relationship').data('key', key).data('rev', rev);
		}
	});
};

var	deleteRel = function (){
	var ask = confirm("Delete Realtionship?");
	if (ask) {
		var doc = {
				'_id': $(this).data('key'),
				'_rev': $(this).data('rev')
		};
		$.couch.db('asdproject').removeDoc(doc, {
			success: function(data){
				alert("Deleted.");
				console.log('');
				window.location.reload();
			}
		});
	} else {
		alert("Canceled.");
	}		
};









	
/*var deleteItem = function(keyVar){
		var ask = confirm("Are you sure?");
		if(ask){
			localStorage.removeItem(keyVar);
			alert("Relationship deleted.");
			window.location = "#add";
			window.location.reload("#");
		}else{
			alert("Canceled.");
		}
	};    
    var editItem = function(keyVar) {
		var obj = JSON.parse(localStorage.getItem(keyVar));
		$("#status").val(obj.status[1]);
		$("#name").val(obj.name[1]);
		$("#tel").val(obj.tel[1]);
		$("#notes").val(obj.notes[1]);
		$('#saveData').prev('.ui-btn-inner').children('.ui-btn-text').html('Update Relationship');
		$("#saveData").val('Update Relationship').data('key', keyVar); 
    };
    

var getData = function(key){
	if(localStorage.length === 0){
		alert("There is no data in Local Storage so default data was added.");
		autoFillData();
	}
	
		for (var i = 0, j = localStorage.length; i < j; i++) {
		var key = localStorage.key(i),
			value = localStorage.getItem(key),
			obj = JSON.parse(value),
			makeRecord = $('<div></div>'),
			makeList = $(
					"<p>" + obj.status[0] + " " + obj.status[1] + "</p>" + 
					"<p>" + obj.name[0] + " " + obj.name[1] + "</p>" +
					"<p>" + obj.tel[0] + " " + obj.tel[1] + "</p>" +
					"<p>" + obj.notes[0] + " " + obj.notes[1] + "</p>");
				
			var editRel = $("<button data-key='"+key+"'><a href='#add'> Edit Relationship</a></button>");
				editRel.on('click', function(){
					keyVar = $(this).data('key');
					editItem(keyVar);
				});
			var deleteRel = $("<button data-key='"+key+"'><a href='#add' id='delete"+key+"'>Delete Relationship</a></button>");
				deleteRel.on('click', function(){
					keyVar = $(this).data('key');
					deleteItem(keyVar);
				});	
		makeRecord.append(makeList).append(editRel).append("<br>").append(deleteRel).appendTo("#items");
		}
    };

var keyVar = null;
var item = {};

	var storeData = function(){
		if (keyVar === null) {
    	var id = Math.floor(Math.random() * 10000000);
        item._id = id;
        console.log("no key");
   		}
   		else
   		{
        item._id=keyVar._id;
        item._rev=keyVar._rev;
        console.log("exists");
    }

		item.status = $('#status').val();
		item.name = $('#name').val();
		item.tel = $('#tel').val();
		item.notes = $('#notes').val();

		$.couch.db("asdproject").saveDoc(item, {
        success: function (data) {
        alert("Relationship Saved");
        },
    	});
		alert("Relationship Saved");
   		 window.location.reload("#");
   		 return false;

}; 

		$("#saveData").on('click', function(){
		storeData(keyVar);
		});
		$('#clearData').on('click', clearData);*/